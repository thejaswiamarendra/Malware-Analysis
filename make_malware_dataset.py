import os
import pefile
import pandas as pd

df_benign = pd.read_csv("labels/benign.csv")
df_malware = pd.read_csv("labels/malware.csv")

csv = open('MalwareDataset.csv', 'w')

csv.write("AddressOfEntryPoint,MajorLinkerVersion,MajorImageVersion,MajorOperatingSystemVersion,DllCharacteristics,SizeOfStackReserve,NumberOfSections,ResourceSize,malice,generic,trojan,ransomware,worm,backdoor,spyware,rootkit,encrypter,downloader,\n")


for i in range(len(df_benign)):
        print("Reading Benign files ....        ", "{:.2f}".format(i*100/len(df_benign)), "%", end='\r')
        if df_benign.iloc[i]['type'] == 0:
                try:
                        suspect_pe = pefile.PE("files/benign/" + df_benign.iloc[i]['hash'] + ".exe")
                except:
                        continue
                csv.write(str(suspect_pe.OPTIONAL_HEADER.AddressOfEntryPoint)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.MajorLinkerVersion)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.MajorImageVersion)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.MajorOperatingSystemVersion)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.DllCharacteristics)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.SizeOfStackReserve)+",")
                csv.write(str(suspect_pe.FILE_HEADER.NumberOfSections)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.DATA_DIRECTORY[2].Size)+",")
                csv.write(str(df_benign.iloc[i]['malice'])+",")
                csv.write(str(df_benign.iloc[i]['generic'])+",")
                csv.write(str(df_benign.iloc[i]['trojan'])+",")
                csv.write(str(df_benign.iloc[i]['ransomware'])+",")
                csv.write(str(df_benign.iloc[i]['worm'])+",")
                csv.write(str(df_benign.iloc[i]['backdoor'])+",")
                csv.write(str(df_benign.iloc[i]['spyware'])+",")
                csv.write(str(df_benign.iloc[i]['rootkit'])+",")
                csv.write(str(df_benign.iloc[i]['encrypter'])+",")
                csv.write(str(df_benign.iloc[i]['downloader'])+"\n")
                
for i in range(len(df_malware)):
        print("Reading Malware files ....        ", "{:.2f}".format(i*100/len(df_malware)), "%", end='\r')
        if df_malware.iloc[i]['type'] == 0:
                try:
                        suspect_pe = pefile.PE("files/malware/" + df_malware.iloc[i]['hash'] + ".exe")
                except:
                        continue
                csv.write(str(suspect_pe.OPTIONAL_HEADER.AddressOfEntryPoint)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.MajorLinkerVersion)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.MajorImageVersion)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.MajorOperatingSystemVersion)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.DllCharacteristics)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.SizeOfStackReserve)+",")
                csv.write(str(suspect_pe.FILE_HEADER.NumberOfSections)+",")
                csv.write(str(suspect_pe.OPTIONAL_HEADER.DATA_DIRECTORY[2].Size)+",")
                csv.write(str(df_malware.iloc[i]['malice'])+",")
                csv.write(str(df_malware.iloc[i]['generic'])+",")
                csv.write(str(df_malware.iloc[i]['trojan'])+",")
                csv.write(str(df_malware.iloc[i]['ransomware'])+",")
                csv.write(str(df_malware.iloc[i]['worm'])+",")
                csv.write(str(df_malware.iloc[i]['backdoor'])+",")
                csv.write(str(df_malware.iloc[i]['spyware'])+",")
                csv.write(str(df_malware.iloc[i]['rootkit'])+",")
                csv.write(str(df_malware.iloc[i]['encrypter'])+",")
                csv.write(str(df_malware.iloc[i]['downloader'])+"\n")

csv.close()
